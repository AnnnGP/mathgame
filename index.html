<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathGame - Competencia Matem치tica Sincronizada (FINAL)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const e = React.createElement;
        const { useState, useEffect, useCallback } = React;

        const GAME_KEY = 'MathGameSessionState'; 
        const LOCAL_KEY = 'MathGameLocalState'; 

        // Funci칩n para obtener el estado del localStorage
        const getInitialState = (key, defaultState) => {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultState;
            } catch (error) {
                console.error(`Error leyendo ${key}:`, error);
                return defaultState;
            }
        };

        /**
         * Hook personalizado para gestionar el estado global y local.
         */
        const useLocalStorageSync = (initialUrlMode) => {
            
            const globalState = getInitialState(GAME_KEY, {});
            const localState = getInitialState(LOCAL_KEY, {});

            // L칩gica para determinar el modo inicial del DISPOSITIVO
            const determineInitialMode = (gState, lState, urlMode) => {
                // 1. Si la URL es de Profesor, siempre vamos al men칰.
                if (urlMode === 'profesorMenu') return 'profesorMenu';
                
                // 2. Si el juego ya est치 iniciado globalmente.
                if (gState.mode === 'profesorPlaying') {
                    // Si el alumno tiene un equipo, va a jugar.
                    if (lState.teamId !== null) return 'alumnoPlaying';
                    // Si el alumno no tiene equipo, va a seleccionar.
                    return 'selectTeam'; 
                }

                // 3. Si el juego no ha iniciado, usamos el modo local (selectTeam, selectMode)
                return lState.mode || urlMode;
            };

            const [state, setState] = useState(() => ({
                mode: determineInitialMode(globalState, localState, initialUrlMode),
                // 游냍 CORRECCI칍N CR칈TICA: Aseguramos que 'teams' sea un array por defecto
                teams: globalState.teams || [], 
                difficulty: globalState.difficulty || 'media',
                currentQuestion: globalState.currentQuestion || null,
                // 游냍 CORRECCI칍N CR칈TICA: Aseguramos que 'teamAnswers' sea un objeto vac칤o
                teamAnswers: globalState.teamAnswers || {}, 
                showResults: globalState.showResults || false,
                questionNumber: globalState.questionNumber || 1,
                timeLeft: globalState.timeLeft || 20,
                totalQuestions: globalState.totalQuestions || 10,
                numTeams: globalState.numTeams || 3,
                
                teamId: localState.teamId || null, 
                alumnoRespuesta: localState.alumnoRespuesta || null
            }));

            // Funci칩n para actualizar el estado y guardarlo en localStorage
            const updateState = (newState) => {
                setState(prevState => {
                    const updatedState = { ...prevState, ...newState };
                    
                    // 1. Guardar estado compartido (Global)
                    const sharedState = {
                        mode: updatedState.mode,
                        teams: updatedState.teams,
                        difficulty: updatedState.difficulty,
                        currentQuestion: updatedState.currentQuestion,
                        teamAnswers: updatedState.teamAnswers,
                        showResults: updatedState.showResults,
                        questionNumber: updatedState.questionNumber,
                        timeLeft: updatedState.timeLeft,
                        totalQuestions: updatedState.totalQuestions,
                        numTeams: updatedState.numTeams,
                    };
                    localStorage.setItem(GAME_KEY, JSON.stringify(sharedState));

                    // 2. Guardar estado local (Equipo y Modo)
                    const newLocalState = {
                        mode: updatedState.mode, 
                        teamId: updatedState.teamId,
                        alumnoRespuesta: updatedState.alumnoRespuesta 
                    };
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(newLocalState));

                    return updatedState;
                });
            };

            // Efecto para escuchar cambios globales (GAME_KEY) desde OTRAS pesta침as
            useEffect(() => {
                const handleStorageChange = (event) => {
                    if (event.key === GAME_KEY && event.newValue) {
                        const newState = JSON.parse(event.newValue);
                        setState(prevState => {
                            let newMode = prevState.mode;
                            if (newState.mode === 'profesorPlaying' && prevState.teamId !== null) {
                                newMode = 'alumnoPlaying';
                            } else if (newState.mode === 'profesorPlaying' && prevState.teamId === null) {
                                newMode = 'selectTeam';
                            } else if (newState.mode === 'selectMode') {
                                newMode = 'selectMode'; 
                            } else if (newState.mode === 'profesorMenu') {
                                newMode = 'profesorMenu';
                            }
                            
                            // 游냍 CORRECCI칍N: Aseguramos que los valores sean seguros antes de usarlos
                            const newTeams = newState.teams || []; 
                            const newTeamAnswers = newState.teamAnswers || {};


                            return {
                                ...prevState,
                                mode: newMode,
                                teams: newTeams,
                                currentQuestion: newState.currentQuestion,
                                teamAnswers: newTeamAnswers,
                                showResults: newState.showResults,
                                questionNumber: newState.questionNumber,
                                timeLeft: newState.timeLeft,
                                totalQuestions: newState.totalQuestions,
                                numTeams: newState.numTeams,
                                
                                alumnoRespuesta: newState.currentQuestion === prevState.currentQuestion ? prevState.alumnoRespuesta : null
                            };
                        });
                    }
                    if (event.key === GAME_KEY && event.newValue === null) {
                         setState(prevState => ({ ...prevState, mode: 'selectMode' }));
                    }
                };

                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, []);

            return [state, updateState];
        };

        // --- Componente principal MathGame y el resto de funciones... ---
        function MathGame() {
            
            const getUrlMode = () => {
                const params = new URLSearchParams(window.location.search);
                const role = params.get('r');
                if (role === 'profesor') return 'profesorMenu';
                if (role === 'alumno') return 'selectTeam'; 
                return 'selectMode';
            };

            const initialMode = getUrlMode();
            const [state, updateState] = useLocalStorageSync(initialMode);
            const { 
                mode, teams, numTeams, difficulty, currentQuestion, 
                teamAnswers, showResults, questionNumber, timeLeft, 
                totalQuestions, teamId, alumnoRespuesta 
            } = state;


            // Efecto para gestionar el temporizador (Solo para Profesor)
            useEffect(() => {
                if (mode === 'profesorPlaying' && !showResults && timeLeft > 0) {
                    const timer = setTimeout(() => {
                        updateState({ timeLeft: timeLeft - 1 });
                    }, 1000);
                    return () => clearTimeout(timer);
                }
                if (timeLeft === 0 && !showResults && mode === 'profesorPlaying') {
                    updateState({ showResults: true });
                }
            }, [timeLeft, mode, showResults, updateState]);

            // --- L칍GICA DEL JUEGO (Preguntas) ---

            const generateCalculoQuestion = useCallback(() => {
                let a = Math.floor(Math.random() * (difficulty === 'facil' ? 20 : difficulty === 'media' ? 50 : 100)) + 1;
                let b = Math.floor(Math.random() * (difficulty === 'facil' ? 20 : difficulty === 'media' ? 50 : 100)) + 1;
                const operations = ['+', '-', '칑', '칭'];
                const op = operations[Math.floor(Math.random() * operations.length)];
                
                let answer;
                if (op === '+') answer = a + b;
                else if (op === '-') { 
                    answer = Math.abs(a - b); 
                    if (a < b) [a, b] = [b, a]; 
                }
                else if (op === '칑') answer = a * b;
                else { 
                    const divisor = b || 1;
                    const result = Math.floor(a / divisor);
                    a = result * divisor;
                    answer = result;
                }

                const options = [answer];
                while (options.length < 4) {
                    const wrong = answer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * (difficulty === 'facil' ? 5 : 10)) + 1);
                    if (!options.includes(wrong) && wrong > 0) options.push(wrong);
                }

                return { type: 'calculo', question: `${a} ${op} ${b}`, answer, options: options.sort(() => Math.random() - 0.5), icon: '游빑' };
            }, [difficulty]);

            const generateLogicQuestion = useCallback(() => {
                const questions = [
                    { question: 'Si 2+2=5, 3+3=7, 4+4=?', answer: 9, options: [8, 9, 10, 11], hint: 'Mira el patr칩n' },
                    { question: 'Un caracol sube 3m de d칤a y baja 2m de noche. 쮺u치ntos d칤as tarda en subir 10m?', answer: 8, options: [8, 9, 10, 12], hint: 'Piensa en el 칰ltimo d칤a' },
                    { question: '쮺u치ntas veces cabe el n칰mero 1 en el n칰mero 11?', answer: 2, options: [1, 2, 3, 11], hint: 'Cuenta con cuidado' },
                    { question: 'Si un cuadrado tiene 4 lados, 쯖u치ntos lados tiene el 치ngulo de un cuadrado?', answer: 0, options: [0, 1, 2, 4], hint: 'Un 치ngulo no es una forma' },
                    { question: 'Juan tiene 5 manzanas. Da 2 a Mar칤a. 쮺u치ntas le quedan?', answer: 3, options: [1, 2, 3, 5], hint: 'Resta simple' },
                    { question: '쮺u치l es el siguiente n칰mero? 2, 4, 8, 16, ?', answer: 32, options: [24, 28, 32, 64], hint: 'Se multiplica por 2' }
                ];
                const q = questions[Math.floor(Math.random() * questions.length)];
                return { type: 'logica', ...q, icon: '游빌' };
            }, []);

            const generateQuestion = useCallback(() => questionNumber % 2 === 1 ? generateCalculoQuestion() : generateLogicQuestion(), [questionNumber, generateCalculoQuestion, generateLogicQuestion]);


            // --- CONTROL DEL JUEGO ---

            const initGame = () => {
                const newTeams = Array(numTeams).fill(0).map((_, i) => ({ id: i, name: `Equipo ${i + 1}`, score: 0 }));
                updateState({
                    teams: newTeams,
                    teamAnswers: {},
                    questionNumber: 1,
                    currentQuestion: generateQuestion(),
                    timeLeft: 20,
                    showResults: false,
                    mode: 'profesorPlaying'
                });
            };

            const setNumTeamsLocal = (count) => updateState({ numTeams: count });
            const setDifficultyLocal = (level) => updateState({ difficulty: level });
            const setTotalQuestionsLocal = (count) => updateState({ totalQuestions: count });

            const selectAndJoinTeam = (id) => {
                updateState({ teamId: id, mode: 'alumnoPlaying' }); 
            };

            const handleAlumnoAnswer = (option) => updateState({ alumnoRespuesta: option });

            const enviarRespuesta = () => {
                if (alumnoRespuesta !== null) {
                    updateState({ 
                        teamAnswers: { ...teamAnswers, [teamId]: alumnoRespuesta },
                        alumnoRespuesta: null 
                    }); 
                }
            };

            const nextQuestion = () => {
                const newTeams = teams.map(team => {
                    const teamAnswer = teamAnswers[team.id];
                    if (teamAnswer === currentQuestion.answer) {
                        const points = difficulty === 'facil' ? 10 : difficulty === 'media' ? 20 : 30;
                        return { ...team, score: team.score + points };
                    }
                    return team;
                });
                
                if (questionNumber >= totalQuestions) {
                    updateState({ mode: 'resultados', teams: newTeams });
                } else {
                    updateState({
                        teams: newTeams,
                        teamAnswers: {},
                        questionNumber: questionNumber + 1,
                        currentQuestion: generateQuestion(),
                        timeLeft: 20,
                        showResults: false,
                        alumnoRespuesta: null, 
                    });
                }
            };

            const salir = () => {
                // Limpiar TODAS las claves al salir
                localStorage.removeItem(GAME_KEY);
                localStorage.removeItem(LOCAL_KEY);
                updateState({
                    mode: 'selectMode',
                    teams: [],
                    teamAnswers: {},
                    questionNumber: 1,
                    teamId: null,
                    alumnoRespuesta: null,
                    currentQuestion: null,
                });
                window.history.pushState({}, '', window.location.pathname);
            };

            const generateRoleUrl = (role) => {
                const baseURL = window.location.origin + window.location.pathname;
                return `${baseURL}?r=${role}`;
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('URL copiada al portapapeles.');
                }).catch(err => {
                    console.error('Error al copiar: ', err);
                });
            };
            
            // --- VISTAS DEL JUEGO ---

            // PANTALLA INICIAL (Acceso por URLs)
            if (mode === 'selectMode') {
                const urlProfesor = generateRoleUrl('profesor');
                const urlAlumno = generateRoleUrl('alumno');

                return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-
