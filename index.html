<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathGame - Competencia Matemática Sincronizada (FINAL)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const e = React.createElement;
        const { useState, useEffect, useCallback } = React;

        const GAME_KEY = 'MathGameSessionState'; // Estado Global (Profesor)
        const LOCAL_KEY = 'MathGameLocalState'; // Estado Local (Alumno: teamId, mode)

        // Función para obtener el estado del localStorage
        const getInitialState = (key, defaultState) => {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultState;
            } catch (error) {
                console.error(`Error leyendo ${key}:`, error);
                return defaultState;
            }
        };

        /**
         * Hook personalizado para gestionar el estado global y local.
         */
        const useLocalStorageSync = (initialUrlMode) => {
            
            const globalState = getInitialState(GAME_KEY, {});
            const localState = getInitialState(LOCAL_KEY, {});

            // Lógica para determinar el modo inicial del DISPOSITIVO
            const determineInitialMode = (gState, lState, urlMode) => {
                // 1. Si la URL es de Profesor, siempre vamos al menú.
                if (urlMode === 'profesorMenu') return 'profesorMenu';
                
                // 2. Si el juego ya está iniciado globalmente.
                if (gState.mode === 'profesorPlaying') {
                    // Si el alumno tiene un equipo, va a jugar.
                    if (lState.teamId !== null) return 'alumnoPlaying';
                    // Si el alumno no tiene equipo, va a seleccionar.
                    return 'selectTeam'; 
                }

                // 3. Si el juego no ha iniciado, usamos el modo local (selectTeam, selectMode)
                return lState.mode || urlMode;
            };

            const [state, setState] = useState(() => ({
                mode: determineInitialMode(globalState, localState, initialUrlMode),
                teams: globalState.teams || [],
                difficulty: globalState.difficulty || 'media',
                currentQuestion: globalState.currentQuestion || null,
                teamAnswers: globalState.teamAnswers || {},
                showResults: globalState.showResults || false,
                questionNumber: globalState.questionNumber || 1,
                timeLeft: globalState.timeLeft || 20,
                totalQuestions: globalState.totalQuestions || 10,
                numTeams: globalState.numTeams || 3,
                
                // Estados específicos del dispositivo (Alumno)
                teamId: localState.teamId || null, 
                alumnoRespuesta: localState.alumnoRespuesta || null
            }));

            // Función para actualizar el estado y guardarlo en localStorage
            const updateState = (newState) => {
                setState(prevState => {
                    const updatedState = { ...prevState, ...newState };
                    
                    // 1. Guardar estado compartido (Global)
                    const sharedState = {
                        mode: updatedState.mode,
                        teams: updatedState.teams,
                        difficulty: updatedState.difficulty,
                        currentQuestion: updatedState.currentQuestion,
                        teamAnswers: updatedState.teamAnswers,
                        showResults: updatedState.showResults,
                        questionNumber: updatedState.questionNumber,
                        timeLeft: updatedState.timeLeft,
                        totalQuestions: updatedState.totalQuestions,
                        numTeams: updatedState.numTeams,
                    };
                    localStorage.setItem(GAME_KEY, JSON.stringify(sharedState));

                    // 2. Guardar estado local (Equipo y Modo)
                    const newLocalState = {
                        mode: updatedState.mode, 
                        teamId: updatedState.teamId,
                        alumnoRespuesta: updatedState.alumnoRespuesta 
                    };
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(newLocalState));

                    return updatedState;
                });
            };

            // Efecto para escuchar cambios globales (GAME_KEY) desde OTRAS pestañas
            useEffect(() => {
                const handleStorageChange = (event) => {
                    if (event.key === GAME_KEY && event.newValue) {
                        const newState = JSON.parse(event.newValue);
                        setState(prevState => {
                            // Si el profesor inicia el juego, forzamos al alumno a jugar (o seleccionar equipo si no lo ha hecho)
                            let newMode = prevState.mode;
                            if (newState.mode === 'profesorPlaying' && prevState.mode !== 'alumnoPlaying' && prevState.teamId === null) {
                                newMode = 'selectTeam';
                            } else if (newState.mode === 'profesorPlaying' && prevState.teamId !== null) {
                                newMode = 'alumnoPlaying';
                            } else if (newState.mode === 'selectMode') {
                                newMode = 'selectMode'; // Resetear si el profesor sale
                            } else if (newState.mode === 'profesorPlaying' && (prevState.mode === 'profesorMenu' || prevState.mode === 'selectMode')) {
                                newMode = 'selectTeam';
                            } else {
                                newMode = newState.mode;
                            }


                            return {
                                ...prevState,
                                // Sincronizamos el estado de juego
                                mode: newMode,
                                teams: newState.teams,
                                currentQuestion: newState.currentQuestion,
                                teamAnswers: newState.teamAnswers,
                                showResults: newState.showResults,
                                questionNumber: newState.questionNumber,
                                timeLeft: newState.timeLeft,
                                totalQuestions: newState.totalQuestions,
                                numTeams: newState.numTeams,
                                
                                // Resetear respuesta del alumno cuando cambia la pregunta
                                alumnoRespuesta: newState.currentQuestion === prevState.currentQuestion ? prevState.alumnoRespuesta : null
                            };
                        });
                    }
                    // Si el profesor ha reseteado el juego (eliminar ambas claves)
                    if (event.key === GAME_KEY && event.newValue === null) {
                         setState(prevState => ({ ...prevState, mode: 'selectMode' }));
                    }
                };

                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, []);

            return [state, updateState];
        };

        // --- Componente principal MathGame y el resto de funciones... (sin cambios estructurales mayores) ---
        function MathGame() {
            
            const getUrlMode = () => {
                const params = new URLSearchParams(window.location.search);
                const role = params.get('r');
                if (role === 'profesor') return 'profesorMenu';
                if (role === 'alumno') return 'selectTeam'; 
                return 'selectMode';
            };

            const initialMode = getUrlMode();
            const [state, updateState] = useLocalStorageSync(initialMode);
            const { 
                mode, teams, numTeams, difficulty, currentQuestion, 
                teamAnswers, showResults, questionNumber, timeLeft, 
                totalQuestions, teamId, alumnoRespuesta 
            } = state;


            // Efecto para gestionar el temporizador (Solo para Profesor)
            useEffect(() => {
                if (mode === 'profesorPlaying' && !showResults && timeLeft > 0) {
                    const timer = setTimeout(() => {
                        updateState({ timeLeft: timeLeft - 1 });
                    }, 1000);
                    return () => clearTimeout(timer);
                }
