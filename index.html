<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathGame - Competencia Matem치tica</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const e = React.createElement;
        const { useState, useEffect } = React;

        function MathGame() {
            const getUrlPin = () => {
                const params = new URLSearchParams(window.location.search);
                return params.get('pin');
            };

            const [mode, setMode] = useState('selectMode');
            const [gamePin, setGamePin] = useState(() => {
                const urlPin = getUrlPin();
                if (urlPin) return urlPin;
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            });
            const [inputPin, setInputPin] = useState('');
            const [teams, setTeams] = useState([]);
            const [numTeams, setNumTeams] = useState(2);
            const [difficulty, setDifficulty] = useState('media');
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [teamAnswers, setTeamAnswers] = useState({});
            const [showResults, setShowResults] = useState(false);
            const [questionNumber, setQuestionNumber] = useState(1);
            const [timeLeft, setTimeLeft] = useState(20);
            const [totalQuestions, setTotalQuestions] = useState(10);
            const [teamId, setTeamId] = useState(null);
            const [alumnoRespuesta, setAlumnoRespuesta] = useState(null);

            // Efecto para gestionar el temporizador
            useEffect(() => {
                if ((mode === 'profesorPlaying') && !showResults && timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                }
                if (timeLeft === 0 && !showResults && mode === 'profesorPlaying') {
                    setShowResults(true);
                }
            }, [timeLeft, mode, showResults]);

            // **NUEVO Efecto para simular la "sincronizaci칩n" del alumno**
            // Si el alumno est치 esperando y el profesor establece una pregunta, el alumno comienza a jugar.
            useEffect(() => {
                if (mode === 'esperandoPartida' && currentQuestion) {
                    // Asignar al primer equipo disponible de forma simulada
                    const teamIndex = teams.length > 0 ? 0 : null; // Siempre se asigna al Equipo 1 (0)
                    if (teamIndex !== null) {
                        setTeamId(teamIndex);
                        setMode('alumnoPlaying');
                    }
                }
            }, [mode, currentQuestion, teams.length]);
            // **FIN NUEVO Efecto**

            const generateCalculoQuestion = () => {
                let a = Math.floor(Math.random() * (difficulty === 'facil' ? 20 : difficulty === 'media' ? 50 : 100)) + 1;
                let b = Math.floor(Math.random() * (difficulty === 'facil' ? 20 : difficulty === 'media' ? 50 : 100)) + 1;
                const operations = ['+', '-', '칑', '칭'];
                const op = operations[Math.floor(Math.random() * operations.length)];
                
                let answer;
                if (op === '+') answer = a + b;
                else if (op === '-') { 
                    answer = Math.abs(a - b); 
                    if (a < b) [a, b] = [b, a]; 
                }
                else if (op === '칑') answer = a * b;
                else { 
                    // Asegurar que la divisi칩n sea de n칰meros enteros y generar el dividendo
                    const divisor = b || 1;
                    const result = Math.floor(a / divisor);
                    a = result * divisor;
                    answer = result;
                    // Se simplific칩 la generaci칩n para evitar bucles o n칰meros complejos
                }

                const options = [answer];
                while (options.length < 4) {
                    const wrong = answer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * (difficulty === 'facil' ? 5 : 10)) + 1);
                    if (!options.includes(wrong) && wrong > 0) options.push(wrong);
                }

                return { type: 'calculo', question: `${a} ${op} ${b}`, answer, options: options.sort(() => Math.random() - 0.5), icon: '游빑' };
            };

            const generateLogicQuestion = () => {
                const questions = [
                    { question: 'Si 2+2=5, 3+3=7, 4+4=?', answer: 9, options: [8, 9, 10, 11], hint: 'Mira el patr칩n' },
                    { question: 'Un caracol sube 3m de d칤a y baja 2m de noche. 쮺u치ntos d칤as tarda en subir 10m?', answer: 8, options: [8, 9, 10, 12], hint: 'Piensa en el 칰ltimo d칤a' },
                    { question: '쮺u치ntas veces cabe el n칰mero 1 en el n칰mero 11?', answer: 2, options: [1, 2, 3, 11], hint: 'Cuenta con cuidado' },
                    { question: 'Si un cuadrado tiene 4 lados, 쯖u치ntos lados tiene el 치ngulo de un cuadrado?', answer: 0, options: [0, 1, 2, 4], hint: 'Un 치ngulo no es una forma' },
                    { question: 'Juan tiene 5 manzanas. Da 2 a Mar칤a. 쮺u치ntas le quedan?', answer: 3, options: [1, 2, 3, 5], hint: 'Resta simple' },
                    { question: '쮺u치l es el siguiente n칰mero? 2, 4, 8, 16, ?', answer: 32, options: [24, 28, 32, 64], hint: 'Se multiplica por 2' }
                ];
                const q = questions[Math.floor(Math.random() * questions.length)];
                return { type: 'logica', ...q, icon: '游빌' };
            };

            const generateQuestion = () => questionNumber % 2 === 1 ? generateCalculoQuestion() : generateLogicQuestion();

            const initGame = () => {
                const newTeams = Array(numTeams).fill(0).map((_, i) => ({ id: i, name: `Equipo ${i + 1}`, score: 0 }));
                setTeams(newTeams);
                setTeamAnswers({});
                setQuestionNumber(1);
                setCurrentQuestion(generateQuestion());
                setTimeLeft(20);
                setShowResults(false);
                window.history.pushState({}, '', `?pin=${gamePin}`);
                setMode('profesorPlaying');
            };

            const unirAlEquipo = () => {
                if (inputPin.toUpperCase() === gamePin) {
                    // **CORRECCI칍N CLAVE:** El alumno entra en modo de espera
                    setMode('esperandoPartida');
                } else {
                    alert('PIN incorrecto');
                    setInputPin('');
                }
            };

            const handleAlumnoAnswer = (option) => setAlumnoRespuesta(option);

            const enviarRespuesta = () => {
                if (alumnoRespuesta !== null) {
                    // Enviar la respuesta solo si la partida est치 en modo de juego
                    if (mode === 'alumnoPlaying') {
                        setTeamAnswers(prev => ({ ...prev, [teamId]: alumnoRespuesta }));
                        setAlumnoRespuesta(null);
                        // El alumno se queda esperando los resultados y la siguiente pregunta.
                    }
                }
            };

            const nextQuestion = () => {
                if (questionNumber >= totalQuestions) {
                    setMode('resultados');
                } else {
                    const newTeams = teams.map(team => {
                        const teamAnswer = teamAnswers[team.id];
                        if (teamAnswer === currentQuestion.answer) {
                            const points = difficulty === 'facil' ? 10 : difficulty === 'media' ? 20 : 30;
                            return { ...team, score: team.score + points };
                        }
                        return team;
                    });
                    setTeams(newTeams);
                    setTeamAnswers({});
                    setQuestionNumber(questionNumber + 1);
                    setCurrentQuestion(generateQuestion());
                    setTimeLeft(20);
                    setShowResults(false);
                }
            };

            const salir = () => {
                setMode('selectMode');
                setTeams([]);
                setTeamAnswers({});
                setQuestionNumber(1);
                setTeamId(null);
                setAlumnoRespuesta(null);
                setCurrentQuestion(null); // Reiniciar pregunta tambi칠n
                const newPin = Math.random().toString(36).substring(2, 8).toUpperCase();
                setGamePin(newPin);
            };

            const generateQRSvg = () => `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.href)}`;

            const descargarQR = () => {
                const link = document.createElement('a');
                link.href = generateQRSvg();
                link.download = 'MathGame_QR.png';
                link.click();
            };

            // PANTALLA INICIAL
            if (mode === 'selectMode') {
                return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4' },
                    e('div', { className: 'bg-white rounded
