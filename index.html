<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathGame - Competencia Matem√°tica (Firebase)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // ====================================================================================
        // === ‚ö†Ô∏è 1. CONFIGURACI√ìN DE FIREBASE (¬°REEMPLAZA ESTO CON TUS PROPIAS CLAVES!) ===
        // ===       DEBES IR A LA CONSOLA DE FIREBASE > CONFIGURACI√ìN > AGREGAR APP WEB    ===
        // ====================================================================================
        const firebaseConfig = {
          apiKey: "TU_API_KEY_AQUI", // ‚¨ÖÔ∏è REEMPLAZA
          authDomain: "TU_DOMINIO_AQUI.firebaseapp.com", // ‚¨ÖÔ∏è REEMPLAZA
          projectId: "TU-PROJECT-ID-AQUI", // ‚¨ÖÔ∏è REEMPLAZA
          storageBucket: "TU-STORAGE-BUCKET.appspot.com",
          messagingSenderId: "TU_SENDER_ID",
          appId: "TU_APP_ID"
        };
        
        // Inicializar Firebase
        try {
            const app = firebase.initializeApp(firebaseConfig);
            const db = app.firestore();
            // Deshabilitar la advertencia por el uso de compat libraries en Firestore
            db.settings({ experimentalForceLongPolling: true }); 
        } catch (error) {
            console.error("Error al inicializar Firebase. Aseg√∫rate de que las claves son correctas.", error);
            alert("Error al inicializar Firebase. Revisa la consola para m√°s detalles.");
        }
        
        const db = firebase.firestore();
        // ====================================================================================

        const generatePin = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        const GAME_COLLECTION = 'mathGames';

        // ==============================
        // === L√ìGICA DEL JUEGO ===
        // ==============================

        const generateQuestion = (questionNumber, difficulty) => {
            const isCalculo = questionNumber % 2 !== 0; 
            if (isCalculo) {
                // L√≥gica de c√°lculo (optimizado)
                let a, b, answer;
                const operations = ['+', '-', '√ó']; // Simplificamos la divisi√≥n
                const selectedOp = operations[Math.floor(Math.random() * operations.length)];
                let maxVal;

                if (difficulty === 'facil') maxVal = 15;
                else if (difficulty === 'media') maxVal = 30;
                else maxVal = 50;

                a = Math.floor(Math.random() * maxVal) + 1;
                b = Math.floor(Math.random() * maxVal) + 1;

                if (selectedOp === '+') {
                    answer = a + b;
                } else if (selectedOp === '-') {
                    if (a < b) [a, b] = [b, a];
                    answer = a - b;
                } else { // '√ó'
                    if (difficulty === 'facil') b = Math.floor(Math.random() * 8) + 1;
                    answer = a * b;
                }

                const options = [answer];
                while (options.length < 4) {
                    const wrong = answer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 1);
                    if (!options.includes(wrong) && wrong >= 0 && wrong <= 250) options.push(wrong);
                }

                return {
                    type: 'calculo',
                    question: `${a} ${selectedOp} ${b}`,
                    answer: answer,
                    options: options.sort(() => Math.random() - 0.5),
                    icon: 'üßÆ'
                };
            } else {
                // L√≥gica de L√≥gica
                const logicQuestions = [
                  { question: 'Si 2+2=5, 3+3=7, 4+4=?', answer: 9, options: [8, 9, 10, 11], hint: 'La respuesta es el doble +1' },
                  { question: 'Un caracol sube 3m de d√≠a y baja 2m de noche. ¬øCu√°ntos d√≠as tarda en subir 10m?', answer: 8, options: [8, 9, 10, 12], hint: 'Piensa en el √∫ltimo d√≠a' },
                  { question: '¬øCu√°ntas veces cabe el n√∫mero 1 en el n√∫mero 11?', answer: 2, options: [1, 2, 3, 11], hint: 'Contando los d√≠gitos' },
                  { question: 'Si un cuadrado tiene 4 lados, ¬øcu√°ntos lados tiene el √°ngulo de un cuadrado?', answer: 0, options: [0, 1, 2, 4], hint: 'Un √°ngulo no es una forma' },
                  { question: '¬øCu√°l es el siguiente n√∫mero? 2, 4, 8, 16, ?', answer: 32, options: [24, 28, 32, 64], hint: 'Se multiplica por 2' }
                ];
                const q = logicQuestions[Math.floor(Math.random() * logicQuestions.length)];
                return { type: 'logica', ...q, options: [...q.options].sort(() => Math.random() - 0.5), icon: 'üß©' };
            }
        };


        function MathGame() {
          const [mode, setMode] = useState('selectMode');
          const [gamePin, setGamePin] = useState(generatePin());
          const [inputPin, setInputPin] = useState('');
          
          // Estados locales de la partida (sincronizados con Firebase)
          const [teams, setTeams] = useState([]);
          const [numTeams, setNumTeams] = useState(4); // Valor inicial por defecto
          const [difficulty, setDifficulty] = useState('media');
          const [totalQuestions, setTotalQuestions] = useState(10);
          const [questionData, setQuestionData] = useState(null); // Contiene currentQuestion, questionNumber, etc.
          
          // Estados din√°micos
          const [timeLeft, setTimeLeft] = useState(20);
          const [teamAnswers, setTeamAnswers] = useState({}); // Mapa de respuestas {teamId: answer}
          
          // Estados del Alumno (si est√° en la partida)
          const [teamId, setTeamId] = useState(null);
          const [alumnoRespuesta, setAlumnoRespuesta] = useState(null);
          const [respuestaEnviada, setRespuestaEnviada] = useState(false);
          const [isGameActive, setIsGameActive] = useState(false); // Si la partida est√° en curso

          
          // ==============================
          // === FIREBASE LISTENERS ===
          // ==============================

          // 1. Escuchar la partida (Profesor y Alumno)
          useEffect(() => {
            if (gamePin) {
                const gameRef = db.collection(GAME_COLLECTION).doc(gamePin);
                const unsubscribe = gameRef.onSnapshot((doc) => {
                    const data = doc.data();
                    if (data) {
                        // Sincronizar todos los estados
                        setTeams(data.teams || []);
                        setQuestionData(data.questionData || null);
                        setTeamAnswers(data.teamAnswers || {});
                        setTimeLeft(data.timeLeft || 0);
                        setIsGameActive(data.isGameActive || false);

                        if (data.questionData && data.isGameActive && data.questionData.showResults) {
                            // Si el profesor ha mostrado resultados, el alumno ya no puede responder
                            setRespuestaEnviada(true); 
                        }
                    } else if (mode === 'alumnoPlaying') {
                        // Si la partida es borrada por el profesor
                        salir();
                        alert('El profesor ha terminado la sesi√≥n.');
                    }
                }, (error) => {
                    console.error("Error al escuchar Firebase: ", error);
                });
                return () => unsubscribe();
            }
          }, [gamePin, mode]);


          // 2. L√≥gica del Temporizador (SOLO PARA EL PROFESOR)
          useEffect(() => {
            // Solo el profesor gestiona el temporizador y actualiza Firebase
            if (mode === 'profesorPlaying' && isGameActive && questionData && questionData.questionNumber > 0 && !questionData.showResults) {
                if (timeLeft > 0) {
                    const timer = setTimeout(() => {
                        db.collection(GAME_COLLECTION).doc(gamePin).update({ timeLeft: timeLeft - 1 });
                    }, 1000);
                    return () => clearTimeout(timer);
                } 
                
                if (timeLeft === 0) {
                    // Tiempo agotado, mostrar resultados
                    db.collection(GAME_COLLECTION).doc(gamePin).update({
                        'questionData.showResults': true
                    });
                }
            }
          }, [timeLeft, mode, isGameActive, questionData]);
          
          
          // ==============================
          // === FUNCIONES DE FIREBASE ===
          // ==============================

          // Iniciar Juego (Profesor)
          const initGameProfesor = async () => {
            const newTeams = Array(numTeams).fill(0).map((_, i) => ({
              id: i,
              name: `Equipo ${i + 1}`,
              score: 0
            }));

            const initialQuestion = generateQuestion(1, difficulty);
            
            const newQuestionData = {
                currentQuestion: initialQuestion,
                questionNumber: 1,
                showResults: false
            };

            const gameData = {
                teams: newTeams,
                difficulty,
                totalQuestions,
                questionData: newQuestionData,
                teamAnswers: {},
                timeLeft: 20,
                isGameActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection(GAME_COLLECTION).doc(gamePin).set(gameData);
                setMode('profesorPlaying');
            } catch (e) {
                alert('Error al iniciar el juego: ' + e.message);
            }
          };

          // Siguiente pregunta (Profesor)
          const nextQuestion = async () => {
            if (!questionData) return;

            // 1. Calcular puntos
            const currentQuestion = questionData.currentQuestion;
            const currentQuestionNumber = questionData.questionNumber;
            const currentTeams = teams.map(team => {
              const teamAnswer = teamAnswers[team.id];
              const isCorrect = teamAnswer === currentQuestion.answer;

              // Solo los equipos que respondieron y acertaron suman puntos
              if (isCorrect) {
                const points = difficulty === 'facil' ? 10 : difficulty === 'media' ? 20 : 30;
                return { ...team, score: team.score + points };
              }
              return team;
            });
            
            if (currentQuestionNumber >= totalQuestions) {
                // Fin del juego
                await db.collection(GAME_COLLECTION).doc(gamePin).update({
                    teams: currentTeams,
                    isGameActive: false,
                    timeLeft: 0,
                    'questionData.showResults': true // Mostrar resultados finales una √∫ltima vez
                });
                setMode('resultados');
            } else {
                // Siguiente ronda
                const nextNumber = currentQuestionNumber + 1;
                const nextQuestion = generateQuestion(nextNumber, difficulty);

                await db.collection(GAME_COLLECTION).doc(gamePin).update({
                    teams: currentTeams,
                    teamAnswers: {},
                    timeLeft: 20,
                    questionData: {
                        currentQuestion: nextQuestion,
                        questionNumber: nextNumber,
                        showResults: false
                    }
                });
            }
          };
          
          // Unir Alumno a la partida (Alumno)
          const unirAlEquipo = async () => {
            const pin = inputPin.toUpperCase();
            const gameRef = db.collection(GAME_COLLECTION).doc(pin);
            
            try {
                const doc = await gameRef.get();
                if (doc.exists && doc.data().isGameActive) {
                    const data = doc.data();
                    
                    // Asignaci√≥n simple: El alumno siempre es el equipo 0 (solo simulaci√≥n)
                    // En una app real, aqu√≠ se le preguntar√≠a qu√© equipo es.
                    const assignedTeamId = 0; 
                    
                    setTeamId(assignedTeamId); 
                    setGamePin(pin);
                    setMode('alumnoPlaying');
                    setRespuestaEnviada(false);
                    setAlumnoRespuesta(null);
                } else {
                    alert('PIN incorrecto o la sesi√≥n no est√° activa.');
                    setInputPin('');
                }
            } catch (e) {
                alert('Error al conectar: ' + e.message);
            }
          };
          
          // Alumno selecciona respuesta
          const handleAlumnoAnswer = (option) => {
              if (!respuestaEnviada) {
                  setAlumnoRespuesta(option);
              }
          };

          // Alumno env√≠a respuesta a Firebase
          const enviarRespuesta = async () => {
            if (alumnoRespuesta !== null && teamId !== null && gamePin && !respuestaEnviada) {
                const gameRef = db.collection(GAME_COLLECTION).doc(gamePin);
                
                // Actualizar las respuestas en Firestore
                await gameRef.update({
                    [`teamAnswers.${teamId}`]: alumnoRespuesta // Usa notaci√≥n de mapa para actualizar un campo
                });

                setRespuestaEnviada(true);
            }
          };

          // Salir y resetear
          const salir = async () => {
            // El profesor debe borrar la partida
            if (mode === 'profesorPlaying' && isGameActive) {
                 if (confirm("¬øEst√°s seguro que quieres terminar la sesi√≥n y borrar la partida?")) {
                    // No esperar el borrado para cambiar el estado local
                    db.collection(GAME_COLLECTION).doc(gamePin).delete().catch(e => console.error("Error al borrar partida:", e));
                 }
            }
            
            setMode('selectMode');
            setTeams([]);
            setTeamAnswers({});
            setTeamId(null);
            setAlumnoRespuesta(null);
            setRespuestaEnviada(false);
            setGamePin(generatePin());
            setIsGameActive(false);
            setQuestionData(null);
          };

          const generateQRSvg = (pin) => {
            const url = pin ? `${window.location.href}?pin=${pin}` : window.location.href;
            const encodedText = encodeURIComponent(url);
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedText}`;
          };

          // --- VISTAS ---
          
          if (mode === 'selectMode') {
              return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                    <h1 className="text-4xl font-extrabold text-center mb-2 text-gray-800">üß† MathGame</h1>
                    <p className="text-center text-gray-600 mb-8">¬°C√°lculo, l√≥gica y acertijos! Todos juegan a la vez</p>

                    <div className="space-y-4 mb-8">
                      <button
                        onClick={() => setMode('profesorMenu')}
                        className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
                      >
                        üì∫ Soy Profesor
                      </button>
                      <button
                        onClick={() => setMode('alumnoMenu')}
                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
                      >
                        üì± Soy Alumno
                      </button>
                    </div>

                    <div className="border-t-2 border-gray-200 pt-6">
                      <p className="text-center text-sm text-gray-600 mb-4">üì± QR para compartir el juego</p>
                      <div className="flex flex-col items-center gap-4">
                        <img src={generateQRSvg()} alt="MathGame QR" className="w-32 h-32 border-4 border-blue-400 p-2 bg-white rounded-xl shadow-md" />
                      </div>
                    </div>
                  </div>
                </div>
              );
          }


          if (mode === 'profesorMenu') {
            const points = difficulty === 'facil' ? 10 : difficulty === 'media' ? 20 : 30;
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                  <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">Configuraci√≥n Profesor</h1>

                  <div className="bg-yellow-50 border-4 border-yellow-400 p-4 rounded-xl mb-6 text-center shadow-inner">
                    <p className="text-sm font-semibold text-gray-700">C√≥digo de sesi√≥n</p>
                    <p className="text-5xl font-extrabold text-yellow-600 tracking-widest">{gamePin}</p>
                    <p className="text-xs text-gray-600 mt-2">Comparte este PIN con tus alumnos</p>
                  </div>

                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">N√∫mero de equipos: <span className="text-blue-600 font-extrabold">{numTeams}</span></label>
                      <input type="range" min="2" max="6" value={numTeams} onChange={(e) => setNumTeams(parseInt(e.target.value))} className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Dificultad (Puntos por acierto: +{points}):</label>
                      <div className="grid grid-cols-3 gap-2">
                        {['facil', 'media', 'dificil'].map(level => (
                          <button key={level} onClick={() => setDifficulty(level)} className={`w-full py-2 px-4 rounded-lg font-semibold transition shadow ${difficulty === level ? 'bg-blue-600 text-white shadow-xl scale-105' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                            {level.charAt(0).toUpperCase() + level.slice(1)}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">N√∫mero de preguntas: <span className="text-blue-600 font-extrabold">{totalQuestions}</span></label>
                      <input type="range" min="5" max="30" step="5" value={totalQuestions} onChange={(e) => setTotalQuestions(parseInt(e.target.value))} className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" />
                    </div>

                    <button onClick={initGameProfesor} className="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 px-4 rounded-xl font-bold text-lg hover:shadow-2xl transition shadow-lg">‚ñ∂Ô∏è Comenzar Juego</button>
                    <button onClick={salir} className="w-full bg-gray-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-gray-600 transition">Volver</button>
                  </div>
                </div>
              </div>
            );
          }

          if (mode === 'alumnoMenu') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                  <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">Unirse a la partida</h1>

                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">C√≥digo PIN de la sesi√≥n:</label>
                      <input 
                        type="text" 
                        value={inputPin} 
                        onChange={(e) => setInputPin(e.target.value.toUpperCase())} 
                        placeholder="Ej: ABC123" 
                        maxLength="6" 
                        className="w-full p-3 border-4 border-green-400 rounded-lg text-center text-4xl font-extrabold tracking-widest text-gray-800 uppercase focus:border-green-600" 
                      />
                    </div>

                    <button onClick={unirAlEquipo} className="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 px-4 rounded-xl font-bold text-lg hover:shadow-xl transition shadow-lg">üöÄ Unirse</button>
                    <button onClick={() => setMode('selectMode')} className="w-full bg-gray-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-gray-600 transition">Volver</button>
                  </div>
                </div>
              </div>
            );
          }


          // PROFESOR - JUGANDO
          if (mode === 'profesorPlaying' && questionData) {
            const currentQuestion = questionData.currentQuestion;
            const questionNumber = questionData.questionNumber;
            const showResults = questionData.showResults;

            const timeColor = timeLeft > 10 ? 'text-green-600' : timeLeft > 5 ? 'text-yellow-600' : 'text-red-600';
            const isLogicQuestion = currentQuestion?.type === 'logica';
            const currentPoints = difficulty === 'facil' ? 10 : difficulty === 'media' ? 20 : 30;
            const totalAnswered = Object.keys(teamAnswers).length;

            return (
              <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-5xl w-full">
                  <h2 className="text-center text-3xl font-extrabold text-indigo-700 mb-6">Pantalla del Profesor (PIN: {gamePin})</h2>
                  
                  <div className="flex justify-between items-center mb-6 border-b-2 pb-4">
                    <div className="text-center p-3 rounded-lg bg-indigo-50"><p className="text-sm font-semibold text-gray-600">Pregunta</p><p className="text-3xl font-bold text-indigo-600">{questionNumber}/{totalQuestions}</p></div>
                    <div className="text-center p-3 rounded-lg bg-indigo-50"><span className="text-3xl">{currentQuestion?.icon}</span><p className="text-sm font-semibold text-gray-600">{isLogicQuestion ? 'üß© L√≥gica' : 'üßÆ C√°lculo'}</p></div>
                    <div className={`text-center p-3 rounded-lg bg-indigo-50 ${timeColor}`}><p className="text-sm font-semibold text-gray-600">Tiempo</p><p className="text-4xl font-extrabold">{timeLeft}s</p></div>
                  </div>

                  <div className={`rounded-xl p-10 mb-8 text-center shadow-lg border-4 ${isLogicQuestion ? 'bg-gradient-to-r from-purple-100 to-pink-100 border-purple-400' : 'bg-gradient-to-r from-yellow-100 to-yellow-50 border-yellow-400'}`}>
                    <p className={`font-bold ${isLogicQuestion ? 'text-3xl text-purple-800' : 'text-6xl text-gray-800'}`}>{currentQuestion?.question}</p>
                    {isLogicQuestion && <p className="text-lg text-purple-600 italic mt-4">üí° Pista: {currentQuestion?.hint}</p>}
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-8">
                    {currentQuestion?.options.map((option, idx) => (
                      <div key={idx} className={`text-white p-6 rounded-lg font-bold text-3xl text-center opacity-85 shadow-md ${isLogicQuestion ? 'bg-gradient-to-br from-purple-500 to-purple-600' : 'bg-gradient-to-br from-blue-500 to-blue-600'}`}>{option}</div>
                    ))}
                  </div>

                  <div className="mb-6">
                    <p className="text-xl font-bold text-gray-700 mb-3 text-center">Respuestas Recibidas ({totalAnswered}/{numTeams})</p>
                    <div className="grid gap-3" style={{ gridTemplateColumns: `repeat(auto-fit, minmax(150px, 1fr))` }}>
                      {teams.map(team => (
                        <div key={team.id} className={`p-4 rounded-xl text-center font-bold transition shadow ${teamAnswers[team.id] !== undefined ? 'bg-green-100 text-green-800 scale-105 border-4 border-green-500' : 'bg-gray-200 text-gray-600'}`}>
                          <p className="text-sm mb-1">{team.name}</p>
                          <p className="text-2xl">{teamAnswers[team.id] !== undefined ? '¬°Recibida!' : 'Esperando...'}</p>
                        </div>
                      ))}
                    </div>
                  </div>

                  {(showResults || totalAnswered === numTeams) && (
                    <div className="mt-8 p-6 bg-yellow-50 rounded-xl border-4 border-yellow-400 shadow-xl">
                      <p className="text-center font-extrabold text-2xl mb-4 text-green-700">‚úì RESPUESTA CORRECTA: <span className="text-4xl text-green-900">{currentQuestion?.answer}</span></p>
                      
                      <div className="grid gap-3 mb-6" style={{ gridTemplateColumns: `repeat(auto-fit, minmax(120px, 1fr))` }}>
                        {teams.map(team => {
                          const isCorrect = teamAnswers[team.id] === currentQuestion?.answer;
                          const hasAnswered = teamAnswers[team.id] !== undefined;
                          
                          return (
                            <div key={team.id} className={`p-3 rounded-lg text-center font-bold shadow ${isCorrect ? 'bg-green-200 text-green-800 border-2 border-green-500' : hasAnswered ? 'bg-red-200 text-red-800 border-2 border-red-500' : 'bg-gray-200 text-gray-600 border-2 border-gray-400'}`}>
                              <p className="text-sm">{team.name}</p>
                              <p className="text-lg">{isCorrect ? `‚úì +${currentPoints} pts` : '‚úó 0 pts'}</p>
                            </div>
                          );
                        })}
                      </div>

                      <div className="mb-6 p-4 bg-white rounded-lg border-2 border-gray-300 shadow-inner">
                        <p className="text-center font-bold text-gray-700 mb-3 text-xl">üèÜ Clasificaci√≥n Actual</p>
                        <div className="space-y-2">
                          {[...teams].sort((a, b) => b.score - a.score).map((team, idx) => (
                            <div key={team.id} className="flex items-center justify-between px-3 py-2 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                              <span className="font-extrabold text-lg">{idx + 1}. {team.name}</span>
                              <span className="text-xl font-extrabold text-blue-600">{team.score} pts</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <button onClick={nextQuestion} className="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 px-4 rounded-xl font-bold text-lg hover:shadow-2xl transition shadow-lg">
                        {questionNumber < totalQuestions ? 'Siguiente Pregunta ‚Üí' : 'Ver Resultados Finales ‚Üí'}
                      </button>
                    </div>
                  )}

                  <button onClick={salir} className="mt-6 w-full bg-red-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-red-600 transition shadow">üî¥ Salir y Terminar Sesi√≥n</button>
                </div>
              </div>
            );
          }
          
          // ALUMNO - JUGANDO
          if (mode === 'alumnoPlaying' && questionData) {
            const currentQuestion = questionData.currentQuestion;
            const questionNumber = questionData.questionNumber;
            const isLogicQuestion = currentQuestion?.type === 'logica';
            const showResults = questionData.showResults;

            // Reinicia el estado del alumno si la pregunta cambia
            const currentPin = `${questionData.questionNumber}-${currentQuestion?.question}`;
            useEffect(() => {
                setRespuestaEnviada(false);
                setAlumnoRespuesta(null);
            }, [currentPin]);


            if (showResults) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full text-center">
                            <p className="text-5xl mb-4">‚úÖ</p>
                            <h2 className="text-3xl font-bold text-green-800 mb-4">¬°Tiempo agotado!</h2>
                            <p className="text-xl text-gray-600">Esperando la siguiente pregunta del profesor...</p>
                            <button onClick={salir} className="mt-6 w-full bg-red-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-red-600 transition shadow">Salir de la partida</button>
                        </div>
                    </div>
                );
            }

            return (
              <div className="min-h-screen bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
                  <div className="flex justify-between items-center mb-6 border-b-2 pb-4">
                    <div className="text-center flex-1"><p className="text-sm font-semibold text-gray-600">Pregunta</p><p className="text-3xl font-bold text-green-600">{questionNumber}/{totalQuestions}</p></div>
                    <div className="text-center flex-1"><span className="text-3xl">{currentQuestion?.icon}</span><p className="text-sm font-semibold text-gray-600">{isLogicQuestion ? 'üß© L√≥gica' : 'üßÆ C√°lculo'}</p></div>
                    <div className="text-center flex-1"><p className="text-sm font-semibold text-gray-600">Tiempo</p><p className="text-4xl font-extrabold text-red-600">{timeLeft}s</p></div>
                  </div>
                  
                  <div className={`rounded-xl p-8 mb-8 text-center shadow-md border-4 ${isLogicQuestion ? 'bg-gradient-to-r from-purple-100 to-pink-100 border-purple-400' : 'bg-gradient-to-r from-yellow-100 to-yellow-50 border-yellow-400'}`}>
                    <p className={`font-extrabold ${isLogicQuestion ? 'text-3xl text-purple-800' : 'text-5xl text-gray-800'}`}>{currentQuestion?.question}</p>
                    {isLogicQuestion && <p className="text-md text-purple-600 italic mt-3">üí° ¬°A pensar!</p>}
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-6">
                    {currentQuestion?.options.map((option, idx) => (
                      <button 
                        key={idx} 
                        onClick={() => handleAlumnoAnswer(option)} 
                        disabled={respuestaEnviada || timeLeft === 0}
                        className={`text-white p-6 rounded-xl font-bold text-3xl transition transform shadow-lg 
                          ${alumnoRespuesta === option && !respuestaEnviada ? 'ring-4 ring-yellow-400 scale-105' : ''} 
                          ${respuestaEnviada || timeLeft === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:scale-[1.02]'}
                          ${isLogicQuestion ? 'bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600' : 'bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600'}`
                        }
                      >
                        {option}
                      </button>
                    ))}
                  </div>

                  {alumnoRespuesta !== null && !respuestaEnviada && timeLeft > 0 ? (
                    <button onClick={enviarRespuesta} className="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-4 px-4 rounded-xl font-bold text-lg hover:shadow-2xl transition shadow-lg">‚úì ¬°Listo! Enviar Respuesta</button>
                  ) : respuestaEnviada ? (
                    <div className="w-full bg-yellow-500 text-white py-4 px-4 rounded-xl font-bold text-lg text-center shadow-inner">‚úÖ ¬°Respuesta Enviada! Esperando al Profesor...</div>
                  ) : timeLeft === 0 ? (
                      <div className="w-full bg-red-500 text-white py-4 px-4 rounded-xl font-bold text-lg text-center shadow-inner">‚è∞ ¬°Tiempo Agotado!</div>
                  ) : (
                    <div className="w-full bg-gray-300 text-gray-700 py-4 px-4 rounded-xl font-bold text-lg text-center shadow-inner">Selecciona una respuesta para enviar</div>
                  )}
                  
                  <button onClick={salir} className="mt-4 w-full bg-gray-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-gray-600 transition">Salir de la partida</button>
                </div>
              </div>
            );
          }
          
          // RESULTADOS FINALES
          if (mode === 'resultados' && teams.length > 0) {
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);

            return (
              <div className="min-h-screen bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
                  <div className="text-center mb-8">
                    <h1 className="text-5xl font-extrabold text-orange-800 mb-2">üéâ ¬°RESULTADOS FINALES!</h1>
                    <p className="text-xl text-gray-600">¬°Gracias por jugar!</p>
                  </div>

                  <div className="space-y-4 mb-8">
                    {sortedTeams.map((team, idx) => (
                      <div key={team.id} className={`p-5 rounded-xl flex items-center justify-between font-extrabold text-xl shadow-lg ${idx === 0 ? 'bg-yellow-200 border-4 border-yellow-600 text-yellow-900 scale-105' : idx === 1 ? 'bg-gray-200 border-4 border-gray-500 text-gray-800' : idx === 2 ? 'bg-orange-200 border-4 border-orange-500 text-orange-800' : 'bg-white border-2 border-gray-300 text-gray-700'}`}>
                        <span>{idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}¬∫`} - {team.name}</span>
                        <span className="text-3xl">{team.score} PTS</span>
                      </div>
                    ))}
                  </div>

                  <button onClick={salir} className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-xl font-bold text-lg hover:shadow-xl transition shadow-lg">Volver al inicio</button>
                </div>
              </div>
            );
          }
          
          // Fallback o pantalla de carga
          return (
            <div className="min-h-screen bg-gray-900 flex items-center justify-center">
                <p className="text-white text-xl">Cargando la aplicaci√≥n...</p>
            </div>
          );
        }

        // Renderizar la aplicaci√≥n React
        ReactDOM.createRoot(document.getElementById('root')).render(<MathGame />);
    </script>
</body>
</html>
