<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competici√≥n Matem√°tica por Equipos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }
        .icon { width: 64px; height: 64px; stroke-width: 2; }
        .icon-sm { width: 32px; height: 32px; stroke-width: 2; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const TEAMS = [
          { id: 1, name: 'Equipo Rojo', color: 'bg-red-500', dark: 'bg-red-600' },
          { id: 2, name: 'Equipo Azul', color: 'bg-blue-500', dark: 'bg-blue-600' },
          { id: 3, name: 'Equipo Verde', color: 'bg-green-500', dark: 'bg-green-600' },
          { id: 4, name: 'Equipo Amarillo', color: 'bg-yellow-500', dark: 'bg-yellow-600' },
          { id: 5, name: 'Equipo Naranja', color: 'bg-orange-500', dark: 'bg-orange-600' },
          { id: 6, name: 'Equipo Morado', color: 'bg-purple-500', dark: 'bg-purple-600' }
        ];

        const TIME_LIMITS = { math: 17, sequence: 17, visual: 17 };

        const icons = {
          trophy: `<svg class="icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>`,
          users: `<svg class="icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>`,
          clock: `<svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
          calculator: `<svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>`,
          target: `<svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
          brain: `<svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>`,
          monitor: `<svg class="icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`,
          user: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`
        };

        class App {
          constructor() {
            this.view = 'select';
            this.selectedTeam = null;
            this.scores = {};
            this.currentChallenge = null;
            this.answer = '';
            this.feedback = '';
            this.timeLeft = 0;
            this.isActive = false;
            this.timerInterval = null;
            this.syncInterval = null;
            this.difficulty = 1;
            this.usedChallenges = new Set();
            this.playerId = 'player_' + Date.now() + '_' + Math.random();
            this.init();
          }

          async init() {
            this.scores = this.loadScores();
            this.render();
            this.startSync();
            this.startHeartbeat();
          }

          loadScores() {
            try {
              const stored = localStorage.getItem('team-scores');
              if (stored) {
                return JSON.parse(stored);
              }
            } catch (error) {
              console.log('No scores found, initializing...');
            }
            const initial = {};
            TEAMS.forEach(t => initial[t.id] = 0);
            return initial;
          }

          startHeartbeat() {
            // Actualizar presencia cada 3 segundos
            setInterval(() => {
              if (this.selectedTeam) {
                this.updatePlayerPresence();
              }
            }, 3000);
          }

          updatePlayerPresence() {
            if (!this.selectedTeam) return;
            
            const now = Date.now();
            const players = this.getActivePlayers();
            players[this.playerId] = {
              teamId: this.selectedTeam.id,
              lastSeen: now
            };
            
            try {
              localStorage.setItem('active-players', JSON.stringify(players));
            } catch (error) {
              console.error('Error updating presence:', error);
            }
          }

          getActivePlayers() {
            try {
              const stored = localStorage.getItem('active-players');
              if (stored) {
                const players = JSON.parse(stored);
                const now = Date.now();
                // Limpiar jugadores inactivos (m√°s de 10 segundos)
                const active = {};
                for (const [id, data] of Object.entries(players)) {
                  if (now - data.lastSeen < 10000) {
                    active[id] = data;
                  }
                }
                return active;
              }
            } catch (error) {
              console.log('No active players found');
            }
            return {};
          }

          getTeamPlayerCount(teamId) {
            const players = this.getActivePlayers();
            return Object.values(players).filter(p => p.teamId === teamId).length;
          }

          startSync() {
            this.syncInterval = setInterval(() => {
              if (this.view === 'display' || this.view === 'team-select') {
                this.scores = this.loadScores();
                this.render();
              }
            }, 1000);
          }

          updateScore(teamId, points) {
            this.scores[teamId] = (this.scores[teamId] || 0) + points;
            try {
              localStorage.setItem('team-scores', JSON.stringify(this.scores));
            } catch (error) {
              console.error('Error saving scores:', error);
            }
          }

          resetScores() {
            TEAMS.forEach(t => this.scores[t.id] = 0);
            try {
              localStorage.setItem('team-scores', JSON.stringify(this.scores));
              localStorage.removeItem('used-challenges');
            } catch (error) {
              console.error('Error resetting scores:', error);
            }
            this.usedChallenges.clear();
            this.render();
          }

          loadUsedChallenges() {
            try {
              const stored = localStorage.getItem('used-challenges');
              if (stored) {
                return new Set(JSON.parse(stored));
              }
            } catch (error) {
              console.log('No used challenges found');
            }
            return new Set();
          }

          saveUsedChallenges() {
            try {
              localStorage.setItem('used-challenges', JSON.stringify([...this.usedChallenges]));
            } catch (error) {
              console.error('Error saving used challenges:', error);
            }
          }

          generateMathChallenge() {
            const difficulty = Math.min(Math.floor(this.difficulty / 3), 3);
            const ops = [
              { type: '+', min: 5, max: 50, points: 10 },
              { type: '-', min: 5, max: 50, points: 10 },
              { type: '√ó', min: 2, max: 12, points: 15 },
              { type: '√∑', min: 2, max: 10, points: 15 }
            ];
            const op = ops[Math.floor(Math.random() * ops.length)];
            
            const minAdjust = difficulty * 3;
            const maxAdjust = difficulty * 10;
            const minBase = op.min + minAdjust;
            const maxBase = op.max + maxAdjust;
            
            let a, b, result;
            
            if (op.type === '√∑') {
              b = Math.floor(Math.random() * (op.max - op.min + 1)) + op.min;
              result = Math.floor(Math.random() * 10) + 1;
              a = b * result;
            } else {
              a = Math.floor(Math.random() * (maxBase - minBase + 1)) + minBase;
              b = Math.floor(Math.random() * (maxBase - minBase + 1)) + minBase;
              if (op.type === '+') result = a + b;
              else if (op.type === '-') {
                if (a < b) [a, b] = [b, a];
                result = a - b;
              } else if (op.type === '√ó') result = a * b;
            }
            
            const points = op.points;
            return { 
              type: 'math', 
              question: `${a} ${op.type} ${b}`, 
              answer: result, 
              points: points,
              difficulty: this.difficulty
            };
          }

          generateSequenceChallenge() {
            const patterns = [
              // Secuencias aritm√©ticas b√°sicas
              { next: 10, desc: '2, 4, 6, 8, ?' },
              { next: 9, desc: '1, 3, 5, 7, ?' },
              { next: 25, desc: '5, 10, 15, 20, ?' },
              { next: 50, desc: '10, 20, 30, 40, ?' },
              { next: 15, desc: '3, 6, 9, 12, ?' },
              { next: 18, desc: '6, 9, 12, 15, ?' },
              { next: 11, desc: '1, 3, 5, 7, 9, ?' },
              { next: 12, desc: '2, 4, 6, 8, 10, ?' },
              { next: 20, desc: '4, 8, 12, 16, ?' },
              { next: 30, desc: '5, 10, 15, 20, 25, ?' },
              { next: 35, desc: '7, 14, 21, 28, ?' },
              { next: 40, desc: '8, 16, 24, 32, ?' },
              
              // Secuencias geom√©tricas
              { next: 32, desc: '2, 4, 8, 16, ?' },
              { next: 81, desc: '1, 3, 9, 27, ?' },
              { next: 64, desc: '4, 8, 16, 32, ?' },
              { next: 625, desc: '5, 25, 125, ?' },
              { next: 128, desc: '2, 8, 32, ?' },
              
              // Cuadrados perfectos
              { next: 25, desc: '1, 4, 9, 16, ?' },
              { next: 36, desc: '4, 9, 16, 25, ?' },
              { next: 121, desc: '1, 4, 9, 16, 25, 36, 49, 64, 81, 100, ?' },
              { next: 49, desc: '1, 4, 9, 16, 25, 36, ?' },
              
              // Fibonacci
              { next: 13, desc: '1, 1, 2, 3, 5, 8, ?' },
              { next: 55, desc: '1, 2, 3, 5, 8, 13, 21, 34, ?' },
              { next: 21, desc: '1, 1, 2, 3, 5, 8, 13, ?' },
              
              // Secuencias descendentes
              { next: 60, desc: '100, 90, 80, 70, ?' },
              { next: 5, desc: '25, 20, 15, 10, ?' },
              { next: 40, desc: '100, 80, 60, ?' },
              { next: 0, desc: '20, 16, 12, 8, 4, ?' },
              
              // Secuencias con patrones
              { next: 42, desc: '2, 6, 12, 20, 30, ?' },
              { next: 7, desc: '1, 2, 3, 4, 5, 6, ?' },
              { next: 20, desc: '2, 5, 8, 11, 14, 17, ?' },
              { next: 17, desc: '2, 3, 5, 8, 12, ?' },
              { next: 26, desc: '2, 5, 10, 17, ?' },
              { next: 31, desc: '1, 4, 9, 16, 25, ?' },
              { next: 19, desc: '3, 5, 7, 11, 13, 17, ?' },
              
              // M√°s complejas
              { next: 144, desc: '1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, ?' },
              { next: 89, desc: '1, 1, 2, 3, 5, 8, 13, 21, 34, 55, ?' },
              { next: 100, desc: '10, 20, 30, 40, 50, 60, 70, 80, 90, ?' }
            ];
            
            const p = patterns[Math.floor(Math.random() * patterns.length)];
            const points = 20;
            
            return { 
              type: 'sequence', 
              question: `¬øQu√© n√∫mero sigue? ${p.desc}`, 
              answer: p.next, 
              points: points,
              difficulty: this.difficulty
            };
          }

          generateVisualChallenge() {
            const challenges = [
              { q: 'üî¥üî¥üîµüî¥üî¥üîµüî¥üî¥ ¬øQu√© sigue?', opts: ['üîµ', 'üî¥', 'üü¢', 'üü°'], ans: 'üîµ' },
              { q: '‚≠ê‚≠ê‚≠êüåô‚≠ê‚≠ê‚≠êüåô ¬øQu√© sigue?', opts: ['üåô', '‚≠ê', '‚òÄÔ∏è', 'üåü'], ans: '‚≠ê' },
              { q: 'üü•üü¶üü¶üü•üü¶üü¶ ¬øQu√© sigue?', opts: ['üü¶', 'üü•', 'üü©', 'üü®'], ans: 'üü•' },
              { q: '1Ô∏è‚É£2Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£3Ô∏è‚É£3Ô∏è‚É£ ¬øQu√© sigue?', opts: ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£'], ans: '4Ô∏è‚É£' },
              { q: 'üåïüåóüåëüåïüåóüåë ¬øQu√© sigue?', opts: ['üåï', 'üåó', 'üåë', 'üåò'], ans: 'üåï' },
              { q: 'üü¢üîµüü¢üîµüü¢üîµ ¬øQu√© sigue?', opts: ['üü¢', 'üîµ', 'üü°', 'üî¥'], ans: 'üü¢' },
              { q: 'üçéüçéüçåüçéüçéüçå ¬øQu√© sigue?', opts: ['üçé', 'üçå', 'üçä', 'üçá'], ans: 'üçé' },
              { q: '‚ö™‚ö´‚ö™‚ö´‚ö™‚ö´ ¬øQu√© sigue?', opts: ['‚ö™', '‚ö´', 'üî¥', 'üü°'], ans: '‚ö™' },
              { q: 'üü©üü®üü¶üü©üü®üü¶ ¬øQu√© sigue?', opts: ['üü©', 'üü®', 'üü¶', 'üü™'], ans: 'üü©' },
              { q: '‚≠êüåü‚ú®‚≠êüåü‚ú® ¬øQu√© sigue?', opts: ['‚≠ê', 'üåü', '‚ú®', 'üí´'], ans: '‚≠ê' },
              { q: 'üî¥üî¥üî¥üîµüî¥üî¥üî¥üîµ ¬øQu√© sigue?', opts: ['üîµ', 'üî¥', 'üü¢', 'üü°'], ans: 'üî¥' },
              { q: 'üåªüåªüå∫üåªüåªüå∫ ¬øQu√© sigue?', opts: ['üåª', 'üå∫', 'üå∑', 'üå∏'], ans: 'üåª' },
              { q: 'üü°üü°üü°üîµüü°üü°üü°üîµ ¬øQu√© sigue?', opts: ['üîµ', 'üü°', 'üü¢', 'üî¥'], ans: 'üü°' },
              { q: 'üëÄüëÅÔ∏èüëÅÔ∏èüëÄüëÅÔ∏èüëÅÔ∏è ¬øQu√© sigue?', opts: ['üëÄ', 'üëÅÔ∏è', 'üëÇ', 'üëÉ'], ans: 'üëÄ' },
              { q: 'üíéüíéüíéüî∂üíéüíéüíéüî∂ ¬øQu√© sigue?', opts: ['üî∂', 'üíé', 'üíç', '‚ú®'], ans: 'üíé' },
              { q: 'üåà‚òÄÔ∏èüåà‚òÄÔ∏èüåà‚òÄÔ∏è ¬øQu√© sigue?', opts: ['üåà', '‚òÄÔ∏è', '‚õÖ', 'üåô'], ans: 'üåà' },
              { q: 'üéµüé∂üéµüé∂üéµüé∂ ¬øQu√© sigue?', opts: ['üéµ', 'üé∂', 'üéº', 'üé§'], ans: 'üéµ' },
              { q: 'üçïüçïüçîüçïüçïüçî ¬øQu√© sigue?', opts: ['üçï', 'üçî', 'üå≠', 'üçü'], ans: 'üçï' },
              { q: 'üê∂üê±üê∂üê±üê∂üê± ¬øQu√© sigue?', opts: ['üê∂', 'üê±', 'üê≠', 'üêπ'], ans: 'üê∂' },
              { q: '‚öΩüèÄ‚öΩüèÄ‚öΩüèÄ ¬øQu√© sigue?', opts: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ'], ans: '‚öΩ' },
              { q: 'üåô‚≠ê‚≠êüåô‚≠ê‚≠ê ¬øQu√© sigue?', opts: ['üåô', '‚≠ê', '‚òÄÔ∏è', 'üåü'], ans: 'üåô' },
              { q: 'üî•üíßüî•üíßüî•üíß ¬øQu√© sigue?', opts: ['üî•', 'üíß', 'üå™Ô∏è', '‚ö°'], ans: 'üî•' },
              { q: 'üéàüéàüéâüéàüéàüéâ ¬øQu√© sigue?', opts: ['üéà', 'üéâ', 'üéÅ', 'üéä'], ans: 'üéà' },
              { q: 'üè†üè¢üè†üè¢üè†üè¢ ¬øQu√© sigue?', opts: ['üè†', 'üè¢', 'üè¨', 'üè≠'], ans: 'üè†' },
              { q: 'üå∏üå∫üå∏üå∫üå∏üå∫ ¬øQu√© sigue?', opts: ['üå∏', 'üå∫', 'üåª', 'üå∑'], ans: 'üå∏' }
            ];
            
            const c = challenges[Math.floor(Math.random() * challenges.length)];
            const points = 25;
            
            return { 
              type: 'visual', 
              question: c.q, 
              options: c.opts, 
              answer: c.ans, 
              points: points,
              difficulty: this.difficulty
            };
          }

          selectTeam(teamId) {
            this.selectedTeam = TEAMS.find(t => t.id === teamId);
            this.view = 'game';
            this.usedChallenges = this.loadUsedChallenges();
            this.updatePlayerPresence();
            this.startNewChallenge();
          }

          startNewChallenge() {
            const rand = Math.random();
            let challenge;
            let attempts = 0;
            
            do {
              if (rand < 0.4) challenge = this.generateMathChallenge();
              else if (rand < 0.7) challenge = this.generateSequenceChallenge();
              else challenge = this.generateVisualChallenge();
              
              const challengeKey = `${challenge.type}:${challenge.question}:${challenge.answer}`;
              
              if (!this.usedChallenges.has(challengeKey)) {
                this.usedChallenges.add(challengeKey);
                this.saveUsedChallenges();
                break;
              }
              attempts++;
            } while (attempts < 50);
            
            // Si se usaron todos los retos, limpiar y empezar de nuevo
            if (attempts >= 50) {
              this.usedChallenges.clear();
              this.saveUsedChallenges();
              if (rand < 0.4) challenge = this.generateMathChallenge();
              else if (rand < 0.7) challenge = this.generateSequenceChallenge();
              else challenge = this.generateVisualChallenge();
            }
            
            this.currentChallenge = challenge;
            this.answer = '';
            this.feedback = '';
            this.timeLeft = TIME_LIMITS[this.currentChallenge.type];
            this.isActive = true;
            this.startTimer();
            this.render();
          }

          startTimer() {
            if (this.timerInterval) clearInterval(this.timerInterval);
            this.timerInterval = setInterval(() => {
              if (this.timeLeft > 0 && this.isActive) {
                this.timeLeft--;
                this.updateTimer();
              } else if (this.timeLeft <= 0 && this.isActive) {
                this.isActive = false;
                clearInterval(this.timerInterval);
                this.feedback = '‚è±Ô∏è ¬°Tiempo agotado!';
                this.render();
                setTimeout(() => this.startNewChallenge(), 2000);
              }
            }, 1000);
          }

          updateTimer() {
            const timerEl = document.getElementById('timer-display');
            const timerContainerEl = document.getElementById('timer-container');
            if (timerEl && timerContainerEl) {
              timerEl.textContent = this.timeLeft + 's';
              const pct = (this.timeLeft / TIME_LIMITS[this.currentChallenge.type]) * 100;
              const colorClass = pct > 60 ? 'text-green-400' : pct > 30 ? 'text-yellow-400' : 'text-red-400';
              timerContainerEl.className = `flex items-center gap-2 ${colorClass} font-bold text-2xl`;
            }
          }

          checkAnswer() {
            if (!this.answer && this.currentChallenge.type !== 'visual') {
              this.feedback = 'Escribe una respuesta';
              this.render();
              return;
            }

            this.isActive = false;
            clearInterval(this.timerInterval);
            const isCorrect = this.currentChallenge.type === 'visual'
              ? this.answer === this.currentChallenge.answer
              : parseInt(this.answer) === this.currentChallenge.answer;

            if (isCorrect) {
              const bonus = this.timeLeft > TIME_LIMITS[this.currentChallenge.type] * 0.7 ? 5 : 0;
              const total = this.currentChallenge.points + bonus;
              this.updateScore(this.selectedTeam.id, total);
              this.difficulty++;
              this.feedback = `¬°CORRECTO! +${total} puntos ${bonus > 0 ? 'üöÄ ¬°Bonus!' : 'üéâ'}`;
              this.render();
              setTimeout(() => this.startNewChallenge(), 2000);
            } else {
              this.difficulty = Math.max(1, this.difficulty - 1);
              this.feedback = `‚ùå Incorrecto. La respuesta era: ${this.currentChallenge.answer}`;
              this.render();
              setTimeout(() => this.startNewChallenge(), 3000);
            }
          }

          getTimeColor() {
            if (!this.currentChallenge) return 'text-green-400';
            const pct = (this.timeLeft / TIME_LIMITS[this.currentChallenge.type]) * 100;
            return pct > 60 ? 'text-green-400' : pct > 30 ? 'text-yellow-400' : 'text-red-400';
          }

          render() {
            const app = document.getElementById('app');
            
            if (this.view === 'select') {
              app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-600 p-4">
                  <div class="max-w-4xl mx-auto pt-12">
                    <div class="text-center mb-12">
                      <h1 class="text-5xl md:text-6xl font-bold text-white mb-4">üèÜ Competici√≥n Matem√°tica üèÜ</h1>
                      <p class="text-xl text-blue-100">Elige tu opci√≥n</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <button onclick="app.view='team-select';app.render()" class="bg-white rounded-2xl p-8 shadow-2xl hover:scale-105 transition-transform">
                        ${icons.users}
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 mt-4">Jugar</h2>
                        <p class="text-gray-600">M√≥viles - Selecciona equipo</p>
                      </button>
                      <button onclick="app.view='display';app.render()" class="bg-white rounded-2xl p-8 shadow-2xl hover:scale-105 transition-transform">
